---
import AdminLayout from "../../../layouts/AdminLayout.astro";

// --- 1. SETUP VARIABEL ---
let transactions: any[] = []; 
let detailItems: any[] = [];
let selectedTransaction: any = null;
let totalPenghasilan = 0;
let totalPengunjung = 0;

// Helper: Format Rupiah
const formatRupiah = (number: any) => {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0
    }).format(number);
}

// Helper: Format Tanggal
const formatDate = (dateString: any) => {
    if (!dateString) return "-";
    return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
}

try {
    // --- 2. FETCH LIST TRANSAKSI (Main Data) ---
    const res = await fetch('http://localhost:3000/api/transactions'); 
    const data = await res.json();
    const rawData = data.data || data || [];

    // Mapping Data
    transactions = rawData.map((t: any, index: number) => ({
        no: index + 1,
        id: t.ORDER_ID, 
        customer: t.CUST_NAME || "Non-Member",
        date: t.ORDER_DATE,
        gateway: t.PAYMENT_METHOD || "Tunai",
        total: t.TOTAL,
        receipt: t.RECEIPT_NUMBER
    }));

    totalPengunjung = transactions.length;
    totalPenghasilan = transactions.reduce((acc, curr) => acc + Number(curr.total), 0);

    // --- 3. LOGIKA SERVER: HANDLE DETAIL (Berdasarkan URL ?id=...) ---
    const selectedId = Astro.url.searchParams.get('id'); // Ambil ID dari URL

    if (selectedId) {
        // A. Cari Header Transaksi dari list yang sudah ada
        selectedTransaction = transactions.find(t => String(t.id) === String(selectedId));

        // B. Fetch Item Detail dari Backend (Server-Side Fetch)
        if (selectedTransaction) {
            const resDetail = await fetch(`http://localhost:3000/api/transactions/${selectedId}`);
            const rawItems = await resDetail.json();
            
            // Mapping Item agar aman
            detailItems = (rawItems || []).map((item: any) => ({
                name: item.PRODUCT_NAME || item.product_name || "Produk dihapus",
                price: item.PRICE || item.price || 0,
                qty: item.QUANTITY || item.QTY || item.qty || 0,
                subtotal: item.SUBTOTAL || ((item.PRICE || 0) * (item.QUANTITY || 0))
            }));
        }
    }

} catch (e) {
    console.error("Error Fetching Data:", e);
}
---

<AdminLayout title="Transaksi">
  <h2 class="text-3xl font-bold mb-6">Daftar Transaksi</h2>

  <div class="flex flex-col xl:flex-row gap-6">
    
    <div class="flex-1 space-y-6">
      <div class="bg-white rounded-2xl p-6 shadow border">
        <h3 class="font-bold text-lg mb-4">Transaksi Customers</h3>

        <div class="overflow-x-auto max-h-[400px] overflow-y-auto border border-gray-100 rounded-lg">
          <table class="w-full text-sm">
            <thead class="bg-gray-100 text-gray-600">
              <tr>
                <th class="py-3 px-4 text-left">No</th>
                <th class="py-3 px-4 text-left">ID_Transaksi</th>
                <th class="py-3 px-4 text-left">Customer</th>
                <th class="py-3 px-4 text-left">Date</th>
                <th class="py-3 px-4 text-center">Gateway</th>
                <th class="py-3 px-4 text-right">Total</th>
              </tr>
            </thead>

            <tbody>
              {transactions.map((trx) => (
                <tr class={"border-b transition group hover:bg-gray-50"}>
                    <td class="py-4 px-4 text-gray-500">
                        <a href={`?id=${trx.id}#detail-card`} class="block w-full h-full">{trx.no}.</a>
                    </td>
                    <td class="py-4 px-4 font-bold text-red-600">
                        <a href={`?id=${trx.id}#detail-card`} class="block w-full h-full">#{trx.id}</a>
                    </td>
                    <td class="py-4 px-4 font-medium">
                        <a href={`?id=${trx.id}#detail-card`} class="block w-full h-full">{trx.customer}</a>
                    </td>
                    <td class="py-4 px-4 text-xs text-gray-500">
                        <a href={`?id=${trx.id}#detail-card`} class="block w-full h-full">{formatDate(trx.date)}</a>
                    </td>
                    <td class="py-4 px-4 text-center">
                        <a href={`?id=${trx.id}`} class="block w-full h-full">
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">
                                {trx.gateway}
                            </span>
                        </a>
                    </td>
                    <td class="py-4 px-4 text-right font-semibold text-gray-800">
                        <a href={`?id=${trx.id}`} class="block w-full h-full">{formatRupiah(trx.total)}</a>
                    </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-400 mt-4 italic text-center">*Klik baris untuk lihat detail</p>
      </div>

      {selectedTransaction && (
          <div id="detail-card" class="bg-white rounded-2xl p-6 shadow border animate-fade">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">Detail Transaksi</h3>
                <a href="/admin/transactions" class="text-gray-400 hover:text-red-500 text-sm font-bold no-underline">
                    âœ• Tutup
                </a>
            </div>

            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/3 space-y-4 text-sm">
                    <div>
                        <p class="text-gray-400">ID Transaksi</p>
                        <p class="font-bold text-red-600">#{selectedTransaction.id}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Date</p>
                        <p class="font-semibold">{formatDate(selectedTransaction.date)}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Status</p>
                        <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">PAID</span>
                    </div>
                    <div>
                        <p class="text-gray-400">Pembayaran</p>
                        <p class="font-semibold">{selectedTransaction.gateway}</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Nama</p>
                        <p class="font-bold text-lg">{selectedTransaction.customer}</p>
                    </div>
                </div>

                <div class="w-full md:w-2/3">
                    <div class="border-l-4 border-yellow-400 pl-3 mb-4">
                        <h4 class="font-bold">Item</h4>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4">
                        <table class="w-full text-sm">
                            <thead class="border-b text-gray-500">
                                <tr>
                                    <th class="text-left pb-2">ITEM</th>
                                    <th class="text-left pb-2">HARGA</th>
                                    <th class="text-center pb-2">QTY</th>
                                    <th class="text-right pb-2">SUBTOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                {detailItems.length > 0 ? (
                                    detailItems.map((item) => (
                                        <tr class="hover:bg-gray-100 transition">
                                            <td class="pt-3 pb-1 font-medium text-gray-700">{item.name}</td>
                                            <td class="pt-3 pb-1 text-gray-500">{formatRupiah(item.price)}</td>
                                            <td class="pt-3 pb-1 text-center font-bold">x{item.qty}</td>
                                            <td class="pt-3 pb-1 text-right font-bold text-gray-800">{formatRupiah(item.subtotal)}</td>
                                        </tr>
                                    ))
                                ) : (
                                    <tr><td colspan="4" class="text-center py-4 text-gray-400">Item tidak ditemukan.</td></tr>
                                )}
                            </tbody>
                            <tfoot>
                                <tr class="border-t">
                                    <td colspan="3" class="pt-4 font-bold text-gray-600">Total Pembayaran</td>
                                    <td class="pt-4 text-right font-bold text-lg text-gray-800">
                                        {formatRupiah(selectedTransaction.total)}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
          </div>
      )}
    </div>

    <div class="w-full xl:w-80 space-y-6">
      <div class="bg-white rounded-2xl p-6 shadow border text-center">
        <h4 class="font-bold text-lg mb-4">Penghasilan</h4>
        <div class="bg-red-600 rounded-xl py-4 shadow-lg shadow-red-200">
          <span class="text-yellow-300 text-2xl font-extrabold italic block">
            {formatRupiah(totalPenghasilan)}
          </span>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-6 shadow border text-center">
        <h4 class="font-bold text-lg mb-4">Total Pengunjung</h4>
        <div class="bg-red-600 rounded-xl py-8 shadow-lg shadow-red-200">
          <span class="text-yellow-300 text-4xl font-extrabold italic block">
            {totalPengunjung}
          </span>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

