---
import AdminLayout from "../../../layouts/AdminLayout.astro";

// --- 1. LOGIKA SERVER ACTION (HANDLE DELETE) ---
// Bagian ini akan jalan ketika tombol "Hapus" ditekan (Form disubmit)
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const idToDelete = formData.get("id");

        // Astro Server menelpon Backend API untuk menghapus
        const res = await fetch(`http://localhost:3000/api/categories/${idToDelete}`, {
            method: "DELETE",
        });

        if (res.ok) {
            // Jika sukses, refresh halaman
            return Astro.redirect("/admin/categories");
        } else {
            console.error("Gagal menghapus di backend");
        }
    } catch (error) {
        console.error("Error koneksi saat menghapus:", error);
    }
}

// --- 2. FETCH DATA (TAMPILKAN LIST) ---
let categories = [];
let productCounts: any = {}; 

try {
    const resCat = await fetch('http://localhost:3000/api/categories');
    const dataCat = await resCat.json();
    const rawCategories = dataCat.data || dataCat || [];

    const resProd = await fetch('http://localhost:3000/api/products');
    const dataProd = await resProd.json();
    const rawProducts = dataProd.data || dataProd || [];

    rawCategories.forEach((cat: any) => {
        const catId = cat.CATEGORY_ID || cat.id;
        const productsInCat = rawProducts.filter((p: any) => 
            String(p.CATEGORY_ID || p.category_id) === String(catId)
        );
        productCounts[catId] = productsInCat.length;
    });

    categories = rawCategories.map((c: any) => ({
        id: c.CATEGORY_ID,
        name: c.CATEGORY,
    }));

} catch (e) {
    console.error("Gagal ambil data:", e);
}
---

<AdminLayout title="Kategori">
    <div class="space-y-6">
        
        <h1 class="text-3xl font-bold text-gray-900">Daftar Kategori</h1>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden pb-6">
            
            <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                <span class="text-yellow-500 text-xl">
                    <svg width="21" height="25" viewBox="0 0 21 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.44663 20.5357H21V22.3214H8.44663V20.5357ZM2.32237 21.4286L0.0089669 23.7321L1.27327 25L4.85995 21.4286L1.27327 17.8571L0 19.1161L2.32237 21.4286ZM8.44663 11.6071H21V13.3929H8.44663V11.6071ZM2.32237 12.5L0.0089669 14.8036L1.27327 16.0714L4.85995 12.5L1.27327 8.92857L0 10.1875L2.32237 12.5ZM8.44663 2.67857H21V4.46429H8.44663V2.67857ZM2.32237 3.57143L0.0089669 5.875L1.27327 7.14286L4.85995 3.57143L1.27327 0L0 1.25893L2.32237 3.57143Z" fill="#FEB516"/>
                    </svg>
                </span>
                <h2 class="text-lg font-bold text-gray-800">Kategori Produk</h2>
            </div>

            <div class="w-full">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-200 text-gray-700 font-bold">
                        <tr>
                            <th class="p-4 pl-6">Kategori</th>
                            <th class="p-4 text-center">Produk</th> 
                            <th class="p-4 pr-6 text-right">Aksi</th>
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {categories.length > 0 ? (
                            categories.map((item: any) => (
                                <tr class="hover:bg-gray-50 transition">
                                    
                                    <td class="p-4 pl-6 flex items-center gap-3">
                                        <span class="font-bold text-gray-700">{item.name}</span>
                                    </td>

                                    <td class="p-4 text-center text-gray-700 font-bold">
                                        {productCounts[item.id] || 0}
                                    </td>

                                    <td class="p-4 pr-6 text-right space-x-2">
                                        <a href={`/admin/categories/edit/${item.id}`} 
                                           class="inline-flex items-center gap-1 bg-[#C90003] hover:bg-red-900 text-white text-xs font-bold px-4 py-1.5 rounded-full transition">
                                            <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M14.6989 2.76376C15.1925 2.27005 15.8554 1.98254 16.5531 1.95956C17.2509 1.93658 17.9313 2.17984 18.4563 2.64001L18.5883 2.76376L19.2364 3.41185C19.7298 3.9054 20.0172 4.56811 20.0401 5.26566C20.0631 5.9632 19.82 6.64339 19.3601 7.16835L19.2364 7.30035L8.9587 17.5789C8.81338 17.7242 8.63735 17.8351 8.44353 17.9034L8.29503 17.9465L4.2122 18.8888C4.06914 18.9221 3.92019 18.9205 3.77787 18.8842C3.63556 18.8479 3.50406 18.7779 3.39444 18.6801C3.28483 18.5824 3.20031 18.4597 3.148 18.3225C3.09569 18.1852 3.07712 18.0374 3.09387 17.8915L3.1122 17.7879L4.05362 13.7042C4.10012 13.5039 4.19096 13.3166 4.31945 13.156L4.4212 13.0414L14.6989 2.76376ZM14.0508 6.00418L5.80995 14.245L5.22695 16.7732L7.75512 16.1893L15.9959 7.94843L14.0508 6.00418ZM17.2921 4.05993C17.1343 3.9021 16.9243 3.80729 16.7015 3.79328C16.4787 3.77928 16.2585 3.84703 16.0821 3.98385L15.9959 4.05993L15.3469 4.70801L17.2921 6.65226L17.9402 6.00418C18.098 5.84634 18.1928 5.63633 18.2068 5.41356C18.2209 5.19078 18.1531 4.97055 18.0163 4.79418L17.9402 4.70801L17.2921 4.05993Z" fill="white"/>
                                            </svg>
                                            Edit
                                        </a>

                                        <form method="POST" class="inline" onsubmit="return confirm('⚠️ Yakin hapus kategori ini? Produk di dalamnya mungkin akan error.');">
                                            <input type="hidden" name="id" value={item.id} />
                                            
                                            <button type="submit" 
                                                class="inline-flex items-center justify-center gap-1 bg-[#4C4C4C] hover:bg-gray-700 text-white text-xs font-bold px-4 py-1.5 rounded-full transition cursor-pointer">
                                                <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M11 1.75V3H13.25C13.4489 3 13.6397 3.07902 13.7803 3.21967C13.921 3.36032 14 3.55109 14 3.75C14 3.94891 13.921 4.13968 13.7803 4.28033C13.6397 4.42098 13.4489 4.5 13.25 4.5H2.75C2.55109 4.5 2.36032 4.42098 2.21967 4.28033C2.07902 4.13968 2 3.94891 2 3.75C2 3.55109 2.07902 3.36032 2.21967 3.21967C2.36032 3.07902 2.55109 3 2.75 3H5V1.75C5 0.784 5.784 0 6.75 0H9.25C10.216 0 11 0.784 11 1.75ZM4.496 6.675L5.156 13.275C5.1622 13.3367 5.19112 13.3939 5.23714 13.4355C5.28315 13.4771 5.34298 13.5001 5.405 13.5H10.595C10.657 13.5001 10.7168 13.4771 10.7629 13.4355C10.8089 13.3939 10.8378 13.3367 10.844 13.275L11.504 6.675C11.5288 6.48127 11.6282 6.30486 11.781 6.18328C11.9339 6.06169 12.1281 6.00453 12.3225 6.02394C12.5168 6.04334 12.6959 6.13779 12.8217 6.2872C12.9475 6.43661 13.01 6.6292 12.996 6.824L12.336 13.424C12.2929 13.8558 12.0908 14.2562 11.7691 14.5474C11.4474 14.8386 11.0289 14.9999 10.595 15H5.405C4.97121 14.9999 4.5529 14.8388 4.23121 14.5478C3.90952 14.2567 3.70738 13.8566 3.664 13.425L3.004 6.825C2.99148 6.7257 2.99895 6.6249 3.02599 6.52853C3.05303 6.43217 3.09908 6.34219 3.16144 6.2639C3.22379 6.18561 3.30118 6.12059 3.38905 6.07268C3.47692 6.02476 3.5735 5.99492 3.67308 5.98491C3.77266 5.9749 3.87325 5.98492 3.9689 6.01438C4.06455 6.04385 4.15333 6.09216 4.23002 6.15647C4.30671 6.22078 4.36975 6.29979 4.41543 6.38884C4.46111 6.4779 4.48851 6.57519 4.496 6.675ZM6.5 1.75V3H9.5V1.75C9.5 1.6837 9.47366 1.62011 9.42678 1.57322C9.37989 1.52634 9.3163 1.5 9.25 1.5H6.75C6.6837 1.5 6.62011 1.52634 6.57322 1.57322C6.52634 1.62011 6.5 1.6837 6.5 1.75Z" fill="white"/>
                                                </svg>
                                                Hapus
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colspan="3" class="p-8 text-center text-gray-400">
                                    Belum ada kategori.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>

            <div class="flex justify-center mt-8">
                <a href="/admin/categories/add" 
                   class="bg-[#FEB516] hover:bg-yellow-500 text-white font-bold py-2 px-8 rounded-full shadow-md transition flex items-center gap-2 transform hover:scale-105 active:scale-95">
                    + Tambah Kategori
                </a>
            </div>

        </div>
    </div>
</AdminLayout>