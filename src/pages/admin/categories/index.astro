---
import AdminLayout from "../../../layouts/AdminLayout.astro";

// --- 1. LOGIKA SERVER ACTION (HANDLE DELETE) ---
// Bagian ini akan jalan ketika tombol "Hapus" ditekan (Form disubmit)
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const idToDelete = formData.get("id");

        // Astro Server menelpon Backend API untuk menghapus
        const res = await fetch(`http://localhost:3000/api/categories/${idToDelete}`, {
            method: "DELETE",
        });

        if (res.ok) {
            // Jika sukses, refresh halaman
            return Astro.redirect("/admin/categories");
        } else {
            console.error("Gagal menghapus di backend");
        }
    } catch (error) {
        console.error("Error koneksi saat menghapus:", error);
    }
}

// --- 2. FETCH DATA (TAMPILKAN LIST) ---
let categories = [];
let productCounts: any = {}; 

try {
    const resCat = await fetch('http://localhost:3000/api/categories');
    const dataCat = await resCat.json();
    const rawCategories = dataCat.data || dataCat || [];

    const resProd = await fetch('http://localhost:3000/api/products');
    const dataProd = await resProd.json();
    const rawProducts = dataProd.data || dataProd || [];

    rawCategories.forEach((cat: any) => {
        const catId = cat.CATEGORY_ID || cat.id;
        const productsInCat = rawProducts.filter((p: any) => 
            String(p.CATEGORY_ID || p.category_id) === String(catId)
        );
        productCounts[catId] = productsInCat.length;
    });

    categories = rawCategories.map((c: any) => ({
        id: c.CATEGORY_ID,
        name: c.CATEGORY,
    }));

} catch (e) {
    console.error("Gagal ambil data:", e);
}
---

<AdminLayout title="Kategori">
    <div class="space-y-6">
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <h1 class="text-3xl font-black text-gray-800">Daftar Kategori</h1>

            <a href="/admin/categories/add" class="bg-[#FEB516] hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-xl shadow-lg transition flex items-center gap-2">
                <span>+</span> Tambah Produk
            </a>

        </div>
        
        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden pb-6">
            
            <div class="flex flex-col md:flex-row items-start justify-between md:items-center">
                <span class="text-yellow-500 text-xl flex gap-4 p-5">
                    <svg width="21" height="25" viewBox="0 0 21 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.44663 20.5357H21V22.3214H8.44663V20.5357ZM2.32237 21.4286L0.0089669 23.7321L1.27327 25L4.85995 21.4286L1.27327 17.8571L0 19.1161L2.32237 21.4286ZM8.44663 11.6071H21V13.3929H8.44663V11.6071ZM2.32237 12.5L0.0089669 14.8036L1.27327 16.0714L4.85995 12.5L1.27327 8.92857L0 10.1875L2.32237 12.5ZM8.44663 2.67857H21V4.46429H8.44663V2.67857ZM2.32237 3.57143L0.0089669 5.875L1.27327 7.14286L4.85995 3.57143L1.27327 0L0 1.25893L2.32237 3.57143Z" fill="#FEB516"/>
                    </svg>
                    <h2 class="text-lg font-bold text-gray-800">Kategori Produk</h2>
                </span>
            </a>
            </div>

            <div class="w-full">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-200 text-gray-700 font-bold">
                        <tr>
                            <th class="p-4 pl-6">Kategori</th>
                            <th class="p-4 text-center">Produk</th> 
                            <th class="p-4 pr-6 text-right">Aksi</th>
                        </tr>
                    </thead>
                    
                    <tbody class="divide-y divide-gray-100">
                        {categories.length > 0 ? (
                            categories.map((item: any) => (
                                <tr class="hover:bg-gray-50 transition">
                                    
                                    <td class="p-4 pl-6 flex items-center gap-3">
                                        <span class="font-bold text-gray-700">{item.name}</span>
                                    </td>

                                    <td class="p-4 text-center text-gray-700 font-bold">
                                        {productCounts[item.id] || 0}
                                    </td>

                                    <td class="p-4 pr-6 text-right space-x-2">
                                        <a href={`/admin/categories/edit/${item.id}`} 
                                           class="inline-flex items-center gap-1 text-white text-xs font-bold px-4 py-1.5 rounded-full transition">
                                            <svg width="27" height="27" viewBox="0 0 27 27" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M18.0394 3.39188C18.6452 2.78596 19.4587 2.43311 20.3151 2.40491C21.1714 2.3767 22.0064 2.67525 22.6508 3.24001L22.8128 3.39188L23.6081 4.18726C24.2137 4.79298 24.5664 5.60631 24.5946 6.46239C24.6228 7.31847 24.3244 8.15324 23.76 8.79751L23.6081 8.95951L10.9946 21.5741C10.8163 21.7525 10.6002 21.8885 10.3624 21.9724L10.1801 22.0253L5.16938 23.1818C4.99381 23.2226 4.81101 23.2206 4.63635 23.1761C4.46169 23.1315 4.3003 23.0456 4.16578 22.9256C4.03125 22.8056 3.92752 22.6551 3.86332 22.4867C3.79912 22.3182 3.77634 22.1368 3.79688 21.9578L3.81938 21.8306L4.97476 16.8188C5.03184 16.5729 5.14332 16.343 5.30101 16.146L5.42588 16.0054L18.0394 3.39188ZM17.244 7.36876L7.13026 17.4825L6.41476 20.5853L9.51751 19.8686L19.6313 9.75488L17.244 7.36876ZM21.222 4.98263C21.0283 4.78894 20.7706 4.67258 20.4971 4.65538C20.2237 4.63819 19.9535 4.72135 19.737 4.88926L19.6313 4.98263L18.8348 5.77801L21.222 8.16413L22.0174 7.36876C22.2111 7.17504 22.3274 6.9173 22.3446 6.6439C22.3618 6.3705 22.2787 6.10021 22.1108 5.88376L22.0174 5.77801L21.222 4.98263Z" fill="black"/>
                                            </svg>                                        
                                        </a>

                                        <form method="POST" class="inline" onsubmit="return confirm('Yakin hapus kategori ini? Produk di dalamnya mungkin akan error.');">
                                            <input type="hidden" name="id" value={item.id} />
                                            <button type="submit" 
                                                class="inline-flex items-center justify-center gap-1 text-white text-xs font-bold px-4 py-1.5 rounded-full transition cursor-pointer">
                                                <svg width="22" height="21" viewBox="0 0 22 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M15.125 2.29688V3.9375H18.2188C18.4923 3.9375 18.7546 4.04121 18.948 4.22582C19.1413 4.41042 19.25 4.6608 19.25 4.92188C19.25 5.18295 19.1413 5.43333 18.948 5.61793C18.7546 5.80254 18.4923 5.90625 18.2188 5.90625H3.78125C3.50775 5.90625 3.24544 5.80254 3.05205 5.61793C2.85865 5.43333 2.75 5.18295 2.75 4.92188C2.75 4.6608 2.85865 4.41042 3.05205 4.22582C3.24544 4.04121 3.50775 3.9375 3.78125 3.9375H6.875V2.29688C6.875 1.029 7.953 0 9.28125 0H12.7188C14.047 0 15.125 1.029 15.125 2.29688ZM6.182 8.76094L7.0895 17.4234C7.09803 17.5044 7.13779 17.5795 7.20106 17.6341C7.26433 17.6887 7.3466 17.7188 7.43188 17.7188H14.5681C14.6534 17.7188 14.7357 17.6887 14.7989 17.6341C14.8622 17.5795 14.902 17.5044 14.9105 17.4234L15.818 8.76094C15.8521 8.50667 15.9888 8.27513 16.1989 8.11555C16.4091 7.95597 16.6762 7.88094 16.9434 7.90642C17.2106 7.93189 17.4569 8.05586 17.6298 8.25196C17.8028 8.44806 17.8888 8.70082 17.8695 8.9565L16.962 17.619C16.9027 18.1857 16.6249 18.7112 16.1825 19.0934C15.7402 19.4757 15.1648 19.6874 14.5681 19.6875H7.43188C6.83541 19.6874 6.26023 19.4759 5.81791 19.0939C5.37559 18.712 5.09765 18.1868 5.038 17.6203L4.1305 8.95781C4.11328 8.82748 4.12356 8.69518 4.16074 8.5687C4.19792 8.44222 4.26124 8.32413 4.34697 8.22137C4.43271 8.11862 4.53912 8.03328 4.65995 7.97039C4.78077 7.9075 4.91356 7.86833 5.05049 7.85519C5.18741 7.84205 5.32571 7.85521 5.45723 7.89388C5.58875 7.93255 5.71083 7.99596 5.81628 8.08037C5.92173 8.16477 6.00841 8.26848 6.07122 8.38536C6.13403 8.50224 6.1717 8.62994 6.182 8.76094ZM8.9375 2.29688V3.9375H13.0625V2.29688C13.0625 2.20985 13.0263 2.12639 12.9618 2.06486C12.8974 2.00332 12.8099 1.96875 12.7188 1.96875H9.28125C9.19008 1.96875 9.10265 2.00332 9.03818 2.06486C8.97372 2.12639 8.9375 2.20985 8.9375 2.29688Z" fill="black"/>
                                                </svg>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            ))
                        ) : (
                            <tr>
                                <td colspan="3" class="p-8 text-center text-gray-400">
                                    Belum ada kategori.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>

            <div class="flex justify-center mt-8">
                <a href="/admin/categories/add" 
                   class="bg-[#FEB516] hover:bg-yellow-500 text-white font-bold py-2 px-8 rounded-full shadow-md transition flex items-center gap-2 transform hover:scale-105 active:scale-95">
                    + Tambah Kategori
                </a>
            </div>

        </div>
    </div>
</AdminLayout>